<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0, maximun-scale=1.0">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-160808688-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-160808688-1');
    </script>

    <!-- additional info of a web page -->
    <title>Title</title>
    <script src="./js/three.js"></script>
    <script src="./js/OBJLoader.js"></script>
    <script src="./js/MTLLoader.js"></script>
    <script src="./js/OrbitControls.js"></script>
    <script src="./js/WebVR.js"></script>
    <script src="./js/dat.gui.js"></script>
    <script src="./js/jQuery.js"></script>

    <script src="./js/EffectComposer.js"></script>
    <script src="./js/RenderPass.js"></script>
    <script src="./js/ShaderPass.js"></script>
    <script src="./js/CopyShader.js"></script>
    <script src="./js/MaskPass.js"></script>

    <script src="./js/avatorLoader.js"></script>

    <script src="./js/sofaTextureLoader.js"></script>
    <script src="./js/sofaLoader.js"></script>
    <script src="./js/handrailTextureLoader.js"></script>
    <script src="./js/handrailLoader.js"></script>
    <script src="./js/plateTextureLoader.js"></script>
    <script src="./js/plateLoader.js"></script>
    <script src="./js/bgImgLoader.js"></script>
    <link rel="stylesheet" href="style.css">

    <style>
        video {
            position: fixed;
            top: 1000px
        }
    </style>
</head>

<body>
    <div id="WebGL-OUTPUT"></div>
    <img src="zheLOGO.png" id="logo">
    <h1>粗旷风面料的三维展示</h1>
    <div id="UI">
        <table class="sofaFrame">
            <tr>
                <td id="sofa1" class="sofaImg"></td>
                <td id="sofa2" class="sofaImg"></td>
                <td id="sofa3" class="sofaImg"></td>
                <td id="sofa4" class="sofaImg"></td>
                <td id="sofa5" class="sofaImg"></td>
            </tr>
        </table>
        <input type="button" id="sofaTexture" value="沙发面料展示" class="btn">

        <table class="handrailFrame">
            <tr>
                <td id="handrail1" class="handrailImg"></td>
                <td id="handrail2" class="handrailImg"></td>
                <td id="handrail3" class="handrailImg"></td>
                <td id="handrail4" class="handrailImg"></td>
                <td id="handrail5" class="handrailImg"></td>
            </tr>
        </table>
        <input type="button" id="handrailTexture" value="扶手面料展示" class="btn">

        <table class="plateFrame">
            <tr>
                <td id="plate1" class="plateImg"></td>
                <td id="plate2" class="plateImg"></td>
                <td id="plate3" class="plateImg"></td>
                <td id="plate4" class="plateImg"></td>
                <td id="plate5" class="plateImg"></td>
            </tr>
        </table>
        <input type="button" id="plateTexture" value="底板颜色选择" class="btn">

        <table id="bgTable">
            <tr>
                <td id="bg1b" class="bg"></td>
                <td id="bg2b" class="bg"></td>
                <td id="bg3b" class="bg"></td>
                <td id="bg4b" class="bg"></td>
                <td id="bg5b" class="bg"></td>
            </tr>
        </table>
        <input type="button" id="videoTexture" value="面料动态展示" class="btn">
    </div>



    <video src="video/videoTexture.mp4" id="textureVideo" autoplay="true" controls="controls"></video>

    <script>

        let objCloth;
        let sofaTexture = null;
        let handrailTexture = null;
        let plateTexture = null;

        let output = document.getElementById("WebGL-OUTPUT");

        let btnSofaTexture = document.getElementById("sofaTexture");
        let btnHandrailTexture = document.getElementById("handrailTexture");
        let btnPlateTexture = document.getElementById("plateTexture");
        let btnVideoTexture = document.getElementById("videoTexture");

        let scene = new THREE.Scene();

        let camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.x = 0;
        camera.position.y = 400;
        camera.position.z = 400;
        camera.lookAt(0, 40, 0);

        let renderer = new THREE.WebGLRenderer();
        renderer.setClearColor(0x000000);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);

        let light = new THREE.AmbientLight(0xffffff, 0.5);
        light.visible = true;
        scene.add(light);
        var light1 = new THREE.SpotLight(0xffffff);
        light1.intensity = 1;
        //light1.castShadow = true;
        light1.position.set(-300, 100, 100);
        light1.visible = true;
        scene.add(light1);
        var light2 = new THREE.SpotLight(0xffffff);
        light2.intensity = 1;
        //light2.castShadow = true;
        light2.position.set(-100, 100, -100);
        light2.visible = true;
        scene.add(light2);
        var light3 = new THREE.SpotLight(0xffffff);
        light3.intensity = 1;
        //light3.castShadow = true;
        light3.position.set(-100, 100, 100);
        light3.visible = false;
        scene.add(light3);
        var light4 = new THREE.SpotLight(0xffffff);
        light4.intensity = 1;
        //light4.castShadow = true;
        light4.position.set(-300, 100, -100);
        light4.visible = false;
        scene.add(light4);

        let para = {
            name: "粗旷风沙发面料三维展示",
            sofatextureRepeat: 0.5,
            handrailtextureRepeat: 0.5,
            r: 125,
            g: 125,
            b: 125,
            light1: true,
            light2: true,
            light3: false,
            light4: false,
            ambiLight: true,
        };

        let gui = new dat.GUI();//定义一个GUI界面
        gui.add(para, "name").name("项目");

        gui.add(para, "sofatextureRepeat").min(0).max(10).step(0.001).name("沙发纹理大小");
        gui.add(para, "handrailtextureRepeat").min(0).max(10).step(0.001).name("扶手纹理大小");

        let color = gui.addFolder('面料颜色');
        color.open();
        color.add(para, "r").min(0).max(255).step(1).name('面料颜色-红');
        color.add(para, "g").min(0).max(255).step(1).name('面料颜色-绿');
        color.add(para, "b").min(0).max(255).step(1).name('面料颜色-蓝');

        gui.add(para, "ambiLight").name("环境光").onChange(function (e) {
            light.visible = e;
        });

        let spotLight = gui.addFolder("聚光灯");
        spotLight.open();
        spotLight.add(para, "light1").name("灯光-1").onChange(function (e) {
            light1.visible = e;
        });
        spotLight.add(para, "light2").name("灯光-2").onChange(function (e) {
            light2.visible = e;
        });
        spotLight.add(para, "light3").name("灯光-3").onChange(function (e) {
            light3.visible = e;
        });
        spotLight.add(para, "light4").name("灯光-4").onChange(function (e) {
            light4.visible = e;
        });

        //沙发纹理加载与沙发模型加载
        $("#sofa1").click(function () {
            sofaTextureLoader("./sofaPicture/", "p1.jpg");
        });
        $("#sofa2").click(function () {
            sofaTextureLoader("./sofaPicture/", "p2.jpg");
        });
        $("#sofa3").click(function () {
            sofaTextureLoader("./sofaPicture/", "p3.jpg");
        });
        $("#sofa4").click(function () {
            sofaTextureLoader("./sofaPicture/", "p4.jpg");
        });
        $("#sofa5").click(function () {
            sofaTextureLoader("./sofaPicture/", "p5.jpg");
        });

        btnSofaTexture.onclick = function () {
            sofaLoader("./models/", "sofa.obj", -200);
        };

        //扶手纹理加载与扶手模型加载
        $("#handrail1").click(function () {
            handrailTextureLoader("./handrailPicture/", "p1.jpg");
        });
        $("#handrail2").click(function () {
            handrailTextureLoader("./handrailPicture/", "p2.jpg");
        });
        $("#handrail3").click(function () {
            handrailTextureLoader("./handrailPicture/", "p3.jpg");
        });
        $("#handrail4").click(function () {
            handrailTextureLoader("./handrailPicture/", "p4.jpg");
        });
        $("#handrail5").click(function () {
            handrailTextureLoader("./handrailPicture/", "p5.jpg");
        });

        btnHandrailTexture.onclick = function () {
            handrailLoader("./models/", "handrail.obj", -200);
        };

        //底板纹理加载与底板模型加载
        $("#plate1").click(function () {
            plateTextureLoader("./platePicture/", "p1.jpg");
        });
        $("#plate2").click(function () {
            plateTextureLoader("./platePicture/", "p2.jpg");
        });
        $("#plate3").click(function () {
            plateTextureLoader("./platePicture/", "p3.jpg");
        });
        $("#plate4").click(function () {
            plateTextureLoader("./platePicture/", "p4.jpg");
        });
        $("#plate5").click(function () {
            plateTextureLoader("./platePicture/", "p5.jpg");
        });

        btnPlateTexture.onclick = function () {
            plateLoader("./models/", "plate.obj", -200);
        };


        //视频纹理设置
        btnVideoTexture.onclick = function () {
            let video = document.getElementById("textureVideo");
            let texture1 = new THREE.VideoTexture(video);
            texture1.minFilter = THREE.LinearFilter;
            texture1.magFilter = THREE.LinearFilter;
            texture1.format = THREE.RGBFormat;
            texture1.wrapS = texture1.wrapT = THREE.ClampToEdgeWrapping;
            texture1.repeat.x = texture1.repeat.y = 1;

            let garment = new THREE.OBJLoader();
            garment.setPath("./models/");
            garment.load("sofa.obj", function (obj) {
                obj.position.y = -30;
                obj.position.x = -200;
                obj.traverse(function (child) {
                    if (child instanceof THREE.Mesh) {
                        child.material.map = texture1;
                        child.material.transparent = true;
                        child.material.opacity = 0.96;
                        console.log(child.name);
                        function animation() {
                            child.material.color.r = para.r / 255;
                            child.material.color.g = para.g / 255;
                            child.material.color.b = para.b / 255;
                            texture1.needsUpdate = true;
                            requestAnimationFrame(animation);
                        }
                        animation();
                    }
                });
                scene.add(obj);
            });
        }








        let controller = new THREE.OrbitControls(camera);

        let sceneBG = new THREE.Scene();

        $("#bg1b").click(function () {
            bgImgLoader("./bgImg/bg1b.jpg", 1, -10);
        });
        $("#bg2b").click(function () {
            bgImgLoader("./bgImg/bg2b.jpg", 1, -10);
        });
        $("#bg3b").click(function () {
            bgImgLoader("./bgImg/bg3b.jpg", 1, -10);
        });
        $("#bg4b").click(function () {
            bgImgLoader("./bgImg/bg4b.jpg", 1, -10);
        });
        $("#bg5b").click(function () {
            bgImgLoader("./bgImg/bg5b.jpg", 1, -10);
        });

        bgImgLoader("./bgImg/bg6b.jpg", 3, -20);
        console.log(innerWidth);
        console.log(innerHeight);




        let lightBG = new THREE.AmbientLight(0xffffff);
        sceneBG.add(lightBG);

        let cameraBG = new THREE.OrthographicCamera(-window.innerWidth, window.innerWidth, window.innerHeight, -window.innerHeight, 0, 1000);
        cameraBG.position.x = 0;
        cameraBG.position.y = 0;
        cameraBG.position.z = 50;
        cameraBG.lookAt(0, 0, 0);

        let renderPass1 = new THREE.RenderPass(sceneBG, cameraBG);
        //renderPass1.clear = false;
        let renderPass2 = new THREE.RenderPass(scene, camera);
        renderPass2.clear = false;

        let composer = new THREE.EffectComposer(renderer);
        composer.addPass(renderPass1);  //添加渲染通道
        composer.addPass(renderPass2);


        let effectCopy = new THREE.ShaderPass(THREE.CopyShader);
        effectCopy.renderToScreen = true;
        composer.addPass(effectCopy);

        output.appendChild(renderer.domElement);

        function looper() {
            renderer.autoClear = false;
            if (sofaTexture != null) {
                sofaTexture.repeat.x = sofaTexture.repeat.y = para.sofatextureRepeat;
            }
            if (handrailTexture != null) {
                handrailTexture.repeat.x = handrailTexture.repeat.y = para.handrailtextureRepeat;
            }
            //renderer.render(scene,camera);
            composer.render();
            controller.update();
            requestAnimationFrame(looper);
        }
        looper();

    </script>

</body>

</html>